#!/bin/sh

# Books/
# \---- category/
#       \---- book.pdf

BOOK_DIR="$HOME/Documents/Books"
[ ! -d "$BOOK_DIR" ] && exit 1

[ -n "$READER" ] && \
    B_READER="$READER" || B_READER="xdg-open"
[ ! "$(command -V "$B_READER")" ] && exit 1

[ ! "$(command -V "fzf")" ] || \
    [ ! "$(command -V "dmenu")" ] && exit 1
[ "$TERM" = "linux" ] && \
    PROMPT="dmenu -i -l 50" || PROMPT="fzf"

while(true); do

    CATEGORY=""
    BOOK=""

    CATEGORY="$(find "$BOOK_DIR" \
        -maxdepth 1 \
        -mindepth 1 \
        -type d \
        -exec basename {} \; | $PROMPT )"

    [ -z "$CATEGORY" ] && exit 1

    if [ -z "$BOOK" ] && [ -n "$CATEGORY" ]; then

        BOOK="$(find "$BOOK_DIR/$CATEGORY" \
            -maxdepth 1 \
            -mindepth 1 \
            -type f \
            -exec basename {} \; | $PROMPT )"
    fi

    [ -f "$BOOK_DIR/$CATEGORY/$BOOK" ] && break

done

if [ -n "$BOOK" ] && [ -n "$CATEGORY" ]; then
    "$B_READER" "$BOOK_DIR/$CATEGORY/$BOOK" 2>/dev/null & 
    exit 0
fi

exit 1
