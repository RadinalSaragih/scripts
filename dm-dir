#!/bin/bash

[ ! "$(command -V "fzf")" ] || \
    [ ! "$(command -V "dmenu")" ] && exit 1

[ -d "$1" ] && start_dir="$1" || exit 1

prompt="dmenu -i -l 50"
[ "$2" = "-t" ] && prompt="fzf"

query_result=""
query_dir="$start_dir"

timeout=10
count=0

while(true); do

    query="$(find -L "$query_dir" -maxdepth 1 -mindepth 1 \
        -exec basename {} \; | $prompt )"

    [ "$count" == "$timeout" ] && exit 1

    if [ -z "$query" ] ; then
        if [ "$query_dir" != "$start_dir" ]; then
            query_dir="$start_dir"
            count=$(( count + 1 ))
            continue
        else
            exit 1
        fi

    else
        query_path="$query_dir/$query"

        if [ -d "$query_path" ]; then
            query_dir="$query_path"
            continue

        elif [ -f "$query_path" ]; then
            query_result="$query_path"
            break
        fi
    fi

done

if [ -n "$query_result" ]; then
    printf "%s\n" "$query_result" 2>/dev/null &
    exit 0
else
    exit 1
fi
